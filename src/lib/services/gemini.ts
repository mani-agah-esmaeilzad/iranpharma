import { GoogleGenerativeAI } from '@google/generative-ai';

// Allow running without API key - will use fallback responses
if (!process.env.GEMINI_API_KEY) {
  console.warn('GEMINI_API_KEY is not set - using fallback responses');
}

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// Gemini Pro model (globally supported)
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash"})
const IRANPHARMA_SYSTEM_PROMPT = `
شما دستیار هوشمند نمایشگاه ایران فارما هستید. نمایشگاهی با موضوع "پایداری، تاب‌آوری و نوآوری در زنجیره تأمین دارو".

اطلاعات نمایشگاه:

**غرفه‌های موجود:**
- شرکت داروسازی اکتوور (غرفه A1): داروهای بیوتکنولوژی، تولید انسولین و واکسن
- گروه داروسازی سبحان (غرفه B2): مکمل‌های غذایی، تحقیق و توسعه  
- داروپخش ایران (غرفه C3): توزیع و لجستیک دارو، زنجیره سرد
- فارمد تجهیزات (غرفه D4): تجهیزات پزشکی، دستگاه‌های تشخیصی

**ساعات کاری:**
- شنبه تا چهارشنبه: ۹:۰۰ الی ۱۸:۰۰
- پنج‌شنبه: ۹:۰۰ الی ۲۰:۰۰
- ساعات ویژه متخصصان: ۸:۰۰ الی ۹:۰۰ (روزهای زوج)

**رویدادهای ویژه:**
- سمینارها: ۱۰:۰۰ و ۱۵:۰۰
- میزگردها: ۱۳:۰۰
- سالن کنفرانس: طبقه دوم

**شرکت‌های حاضر:**
بخش تولید: کیمیا دارو، زهراوی، پارس دارو
بخش فناوری: ایران تک فارما، دیجی فارما  
بخش توزیع: داروپخش رازی، شبکه توزیع پارسیان

**اطلاعات تماس:**
- تلفن: ۰۲۱-۸۸۷۷۶۶۵۵ (داخلی ۱۲۳)
- میز راهنمایی: طبقه همکف - ورودی اصلی
- ساعت کاری میز راهنمایی: ۸:۰۰ الی ۱۹:۰۰
- واتساپ: ۰۹۱۲۱۲۳۴۵۶۷
- ایمیل: info@iranpharma-expo.ir

دستورالعمل‌ها:
- همیشه به فارسی پاسخ دهید
- مهربان و مفید باشید
- اطلاعات دقیق و کاربردی ارائه دهید
- از ایموجی استفاده کنید
- اگر سؤال خارج از حوزه نمایشگاه بود، کاربر را به میز راهنمایی هدایت کنید
`;

// Fallback responses for when Gemini API is not available
const fallbackResponses = {
  "لیست غرفه‌های موجود در نمایشگاه را با اطلاعات کامل به من نشان دهید.": 
    "غرفه‌های موجود در نمایشگاه:\n\n🏢 **شرکت داروسازی اکتوور** - غرفه A1\n• محصولات: داروهای بیوتکنولوژی\n• تخصص: تولید انسولین و واکسن\n\n🏢 **گروه داروسازی سبحان** - غرفه B2\n• محصولات: مکمل‌های غذایی\n• تخصص: تحقیق و توسعه\n\n🏢 **داروپخش ایران** - غرفه C3\n• خدمات: توزیع و لجستیک دارو\n• تخصص: زنجیره سرد\n\n🏢 **فارمد تجهیزات** - غرفه D4\n• محصولات: تجهیزات پزشکی\n• تخصص: دستگاه‌های تشخیصی",
    
  "ساعات کاری و زمان‌بندی نمایشگاه چگونه است؟":
    "📅 **برنامه زمانی نمایشگاه:**\n\n🕘 **ساعات بازدید عمومی:**\n• شنبه تا چهارشنبه: ۹:۰۰ الی ۱۸:۰۰\n• پنج‌شنبه: ۹:۰۰ الی ۲۰:۰۰\n\n🎯 **ساعات ویژه متخصصان:**\n• روزهای زوج: ۸:۰۰ الی ۹:۰۰\n\n⏰ **رویدادهای ویژه:**\n• سمینارها: ۱۰:۰۰ و ۱۵:۰۰\n• میزگردها: ۱۳:۰۰",
    
  "کدام شرکت‌ها در نمایشگاه حضور دارند و چه محصولاتی ارائه می‌دهند؟":
    "🏭 **شرکت‌های حاضر:**\n\n**بخش تولید:**\n• کیمیا دارو - آنتی‌بیوتیک‌ها\n• زهراوی - تجهیزات جراحی\n• پارس دارو - داروهای قلبی عروقی\n\n**بخش فناوری:**\n• ایران تک فارما - سامانه‌های هوشمند\n• دیجی فارما - پلتفرم دیجیتال\n\n**بخش توزیع:**\n• داروپخش رازی\n• شبکه توزیع پارسیان",
    
  "چه رویدادها و سمینارهای ویژه‌ای در نمایشگاه برگزار می‌شود؟":
    "🎓 **رویدادهای ویژه:**\n\n**امروز:**\n• ۱۰:۰۰ - سمینار \"نوآوری در داروسازی\"\n• ۱۳:۰۰ - میزگرد \"زنجیره تأمین پایدار\"\n• ۱۵:۰۰ - کارگاه \"فناوری‌های نوین\"\n\n**فردا:**\n• ۹:۰۰ - همایش \"تاب‌آوری در بحران\"\n• ۱۱:۰۰ - نشست \"استانداردهای بین‌المللی\"\n• ۱۶:۰۰ - ارائه محصولات جدید\n\n📍 **مکان:** سالن کنفرانس طبقه دوم",
    
  "برای دریافت اطلاعات بیشتر و راهنمایی با چه کسی تماس بگیرم؟":
    "📞 **اطلاعات تماس:**\n\n**مرکز اطلاع‌رسانی:**\n• تلفن: ۰۲۱-۸۸۷۷۶۶۵۵\n• داخلی: ۱۲۳\n\n**میز راهنمایی:**\n• طبقه همکف - ورودی اصلی\n• ساعت کاری: ۸:۰۰ الی ۱۹:۰۰\n\n**پشتیبانی فنی:**\n• واتساپ: ۰۹۱۲۱۲۳۴۵۶۷\n• ایمیل: info@iranpharma-expo.ir\n\n🗺️ **راهنمای نمایشگاه:** در میز پذیرش موجود است"
};

export async function generateChatResponse(userMessage: string): Promise<string> {
  // First try Gemini API if API key is configured properly
  if (process.env.GEMINI_API_KEY && process.env.GEMINI_API_KEY !== 'your_gemini_api_key_here') {
    try {
      const prompt = `${IRANPHARMA_SYSTEM_PROMPT}

سؤال کاربر: ${userMessage}

لطفاً پاسخی کامل، مفید و به فارسی ارائه دهید:`;

      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();

      return text;
    } catch (error) {
      console.error('Error generating response from Gemini, falling back to static responses:', error);
      // Fall through to fallback system
    }
  }

  // Fallback to static responses
  const fallbackResponse = fallbackResponses[userMessage as keyof typeof fallbackResponses];
  
  if (fallbackResponse) {
    return fallbackResponse;
  }

  // Default fallback
  return 'متأسفم، اطلاعات کاملی در این زمینه ندارم. لطفاً با میز راهنمایی در ورودی نمایشگاه تماس بگیرید یا از پرسش‌های پیشنهادی استفاده کنید.\n\n📞 تماس: ۰۲۱-۸۸۷۷۶۶۵۵ داخلی ۱۲۳';
}
