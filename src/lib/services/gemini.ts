import { GoogleGenerativeAI } from '@google/generative-ai';

// Allow running without API key - will use fallback responses
if (!process.env.GEMINI_API_KEY) {
  console.warn('GEMINI_API_KEY is not set - using fallback responses');
}

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// Gemini Pro model (globally supported)
const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash"})
const IRANPHARMA_SYSTEM_PROMPT = `
ุดูุง ุฏุณุชุงุฑ ููุดููุฏ ููุงุดฺฏุงู ุงุฑุงู ูุงุฑูุง ูุณุชุฏ. ููุงุดฺฏุงู ุจุง ููุถูุน "ูพุงุฏุงุฑุ ุชุงุจโุขูุฑ ู ููุขูุฑ ุฏุฑ ุฒูุฌุฑู ุชุฃูู ุฏุงุฑู".

ุงุทูุงุนุงุช ููุงุดฺฏุงู:

**ุบุฑููโูุง ููุฌูุฏ:**
- ุดุฑฺฉุช ุฏุงุฑูุณุงุฒ ุงฺฉุชููุฑ (ุบุฑูู A1): ุฏุงุฑููุง ุจูุชฺฉููููฺุ ุชููุฏ ุงูุณููู ู ูุงฺฉุณู
- ฺฏุฑูู ุฏุงุฑูุณุงุฒ ุณุจุญุงู (ุบุฑูู B2): ูฺฉููโูุง ุบุฐุงุ ุชุญูู ู ุชูุณุนู  
- ุฏุงุฑููพุฎุด ุงุฑุงู (ุบุฑูู C3): ุชูุฒุน ู ูุฌุณุชฺฉ ุฏุงุฑูุ ุฒูุฌุฑู ุณุฑุฏ
- ูุงุฑูุฏ ุชุฌูุฒุงุช (ุบุฑูู D4): ุชุฌูุฒุงุช ูพุฒุดฺฉุ ุฏุณุชฺฏุงูโูุง ุชุดุฎุต

**ุณุงุนุงุช ฺฉุงุฑ:**
- ุดูุจู ุชุง ฺูุงุฑุดูุจู: น:ฐฐ ุงู ฑธ:ฐฐ
- ูพูุฌโุดูุจู: น:ฐฐ ุงู ฒฐ:ฐฐ
- ุณุงุนุงุช ูฺู ูุชุฎุตุตุงู: ธ:ฐฐ ุงู น:ฐฐ (ุฑูุฒูุง ุฒูุฌ)

**ุฑูุฏุงุฏูุง ูฺู:**
- ุณููุงุฑูุง: ฑฐ:ฐฐ ู ฑต:ฐฐ
- ูุฒฺฏุฑุฏูุง: ฑณ:ฐฐ
- ุณุงูู ฺฉููุฑุงูุณ: ุทุจูู ุฏูู

**ุดุฑฺฉุชโูุง ุญุงุถุฑ:**
ุจุฎุด ุชููุฏ: ฺฉูุง ุฏุงุฑูุ ุฒูุฑุงูุ ูพุงุฑุณ ุฏุงุฑู
ุจุฎุด ููุงูุฑ: ุงุฑุงู ุชฺฉ ูุงุฑูุงุ ุฏุฌ ูุงุฑูุง  
ุจุฎุด ุชูุฒุน: ุฏุงุฑููพุฎุด ุฑุงุฒุ ุดุจฺฉู ุชูุฒุน ูพุงุฑุณุงู

**ุงุทูุงุนุงุช ุชูุงุณ:**
- ุชููู: ฐฒฑ-ธธททถถตต (ุฏุงุฎู ฑฒณ)
- ูุฒ ุฑุงูููุง: ุทุจูู ููฺฉู - ูุฑูุฏ ุงุตู
- ุณุงุนุช ฺฉุงุฑ ูุฒ ุฑุงูููุง: ธ:ฐฐ ุงู ฑน:ฐฐ
- ูุงุชุณุงูพ: ฐนฑฒฑฒณดตถท
- ุงูู: info@iranpharma-expo.ir

ุฏุณุชูุฑุงูุนููโูุง:
- ููุดู ุจู ูุงุฑุณ ูพุงุณุฎ ุฏูุฏ
- ููุฑุจุงู ู ููุฏ ุจุงุดุฏ
- ุงุทูุงุนุงุช ุฏูู ู ฺฉุงุฑุจุฑุฏ ุงุฑุงุฆู ุฏูุฏ
- ุงุฒ ุงููุฌ ุงุณุชูุงุฏู ฺฉูุฏ
- ุงฺฏุฑ ุณุคุงู ุฎุงุฑุฌ ุงุฒ ุญูุฒู ููุงุดฺฏุงู ุจูุฏุ ฺฉุงุฑุจุฑ ุฑุง ุจู ูุฒ ุฑุงูููุง ูุฏุงุช ฺฉูุฏ
`;

// Fallback responses for when Gemini API is not available
const fallbackResponses = {
  "ูุณุช ุบุฑููโูุง ููุฌูุฏ ุฏุฑ ููุงุดฺฏุงู ุฑุง ุจุง ุงุทูุงุนุงุช ฺฉุงูู ุจู ูู ูุดุงู ุฏูุฏ.": 
    "ุบุฑููโูุง ููุฌูุฏ ุฏุฑ ููุงุดฺฏุงู:\n\n๐ข **ุดุฑฺฉุช ุฏุงุฑูุณุงุฒ ุงฺฉุชููุฑ** - ุบุฑูู A1\nโข ูุญุตููุงุช: ุฏุงุฑููุง ุจูุชฺฉููููฺ\nโข ุชุฎุตุต: ุชููุฏ ุงูุณููู ู ูุงฺฉุณู\n\n๐ข **ฺฏุฑูู ุฏุงุฑูุณุงุฒ ุณุจุญุงู** - ุบุฑูู B2\nโข ูุญุตููุงุช: ูฺฉููโูุง ุบุฐุง\nโข ุชุฎุตุต: ุชุญูู ู ุชูุณุนู\n\n๐ข **ุฏุงุฑููพุฎุด ุงุฑุงู** - ุบุฑูู C3\nโข ุฎุฏูุงุช: ุชูุฒุน ู ูุฌุณุชฺฉ ุฏุงุฑู\nโข ุชุฎุตุต: ุฒูุฌุฑู ุณุฑุฏ\n\n๐ข **ูุงุฑูุฏ ุชุฌูุฒุงุช** - ุบุฑูู D4\nโข ูุญุตููุงุช: ุชุฌูุฒุงุช ูพุฒุดฺฉ\nโข ุชุฎุตุต: ุฏุณุชฺฏุงูโูุง ุชุดุฎุต",
    
  "ุณุงุนุงุช ฺฉุงุฑ ู ุฒูุงูโุจูุฏ ููุงุดฺฏุงู ฺฺฏููู ุงุณุชุ":
    "๐ **ุจุฑูุงูู ุฒูุงู ููุงุดฺฏุงู:**\n\n๐ **ุณุงุนุงุช ุจุงุฒุฏุฏ ุนููู:**\nโข ุดูุจู ุชุง ฺูุงุฑุดูุจู: น:ฐฐ ุงู ฑธ:ฐฐ\nโข ูพูุฌโุดูุจู: น:ฐฐ ุงู ฒฐ:ฐฐ\n\n๐ฏ **ุณุงุนุงุช ูฺู ูุชุฎุตุตุงู:**\nโข ุฑูุฒูุง ุฒูุฌ: ธ:ฐฐ ุงู น:ฐฐ\n\nโฐ **ุฑูุฏุงุฏูุง ูฺู:**\nโข ุณููุงุฑูุง: ฑฐ:ฐฐ ู ฑต:ฐฐ\nโข ูุฒฺฏุฑุฏูุง: ฑณ:ฐฐ",
    
  "ฺฉุฏุงู ุดุฑฺฉุชโูุง ุฏุฑ ููุงุดฺฏุงู ุญุถูุฑ ุฏุงุฑูุฏ ู ฺู ูุญุตููุงุช ุงุฑุงุฆู ูโุฏููุฏุ":
    "๐ญ **ุดุฑฺฉุชโูุง ุญุงุถุฑ:**\n\n**ุจุฎุด ุชููุฏ:**\nโข ฺฉูุง ุฏุงุฑู - ุขูุชโุจูุชฺฉโูุง\nโข ุฒูุฑุงู - ุชุฌูุฒุงุช ุฌุฑุงุญ\nโข ูพุงุฑุณ ุฏุงุฑู - ุฏุงุฑููุง ููุจ ุนุฑูู\n\n**ุจุฎุด ููุงูุฑ:**\nโข ุงุฑุงู ุชฺฉ ูุงุฑูุง - ุณุงูุงููโูุง ููุดููุฏ\nโข ุฏุฌ ูุงุฑูุง - ูพูุชูุฑู ุฏุฌุชุงู\n\n**ุจุฎุด ุชูุฒุน:**\nโข ุฏุงุฑููพุฎุด ุฑุงุฒ\nโข ุดุจฺฉู ุชูุฒุน ูพุงุฑุณุงู",
    
  "ฺู ุฑูุฏุงุฏูุง ู ุณููุงุฑูุง ูฺูโุง ุฏุฑ ููุงุดฺฏุงู ุจุฑฺฏุฒุงุฑ ูโุดูุฏุ":
    "๐ **ุฑูุฏุงุฏูุง ูฺู:**\n\n**ุงูุฑูุฒ:**\nโข ฑฐ:ฐฐ - ุณููุงุฑ \"ููุขูุฑ ุฏุฑ ุฏุงุฑูุณุงุฒ\"\nโข ฑณ:ฐฐ - ูุฒฺฏุฑุฏ \"ุฒูุฌุฑู ุชุฃูู ูพุงุฏุงุฑ\"\nโข ฑต:ฐฐ - ฺฉุงุฑฺฏุงู \"ููุงูุฑโูุง ููู\"\n\n**ูุฑุฏุง:**\nโข น:ฐฐ - ููุงุด \"ุชุงุจโุขูุฑ ุฏุฑ ุจุญุฑุงู\"\nโข ฑฑ:ฐฐ - ูุดุณุช \"ุงุณุชุงูุฏุงุฑุฏูุง ุจูโุงูููู\"\nโข ฑถ:ฐฐ - ุงุฑุงุฆู ูุญุตููุงุช ุฌุฏุฏ\n\n๐ **ูฺฉุงู:** ุณุงูู ฺฉููุฑุงูุณ ุทุจูู ุฏูู",
    
  "ุจุฑุง ุฏุฑุงูุช ุงุทูุงุนุงุช ุจุดุชุฑ ู ุฑุงูููุง ุจุง ฺู ฺฉุณ ุชูุงุณ ุจฺฏุฑูุ":
    "๐ **ุงุทูุงุนุงุช ุชูุงุณ:**\n\n**ูุฑฺฉุฒ ุงุทูุงุนโุฑุณุงู:**\nโข ุชููู: ฐฒฑ-ธธททถถตต\nโข ุฏุงุฎู: ฑฒณ\n\n**ูุฒ ุฑุงูููุง:**\nโข ุทุจูู ููฺฉู - ูุฑูุฏ ุงุตู\nโข ุณุงุนุช ฺฉุงุฑ: ธ:ฐฐ ุงู ฑน:ฐฐ\n\n**ูพุดุชุจุงู ูู:**\nโข ูุงุชุณุงูพ: ฐนฑฒฑฒณดตถท\nโข ุงูู: info@iranpharma-expo.ir\n\n๐บ๏ธ **ุฑุงูููุง ููุงุดฺฏุงู:** ุฏุฑ ูุฒ ูพุฐุฑุด ููุฌูุฏ ุงุณุช"
};

export async function generateChatResponse(userMessage: string): Promise<string> {
  // First try Gemini API if API key is configured properly
  if (process.env.GEMINI_API_KEY && process.env.GEMINI_API_KEY !== 'your_gemini_api_key_here') {
    try {
      const prompt = `${IRANPHARMA_SYSTEM_PROMPT}

ุณุคุงู ฺฉุงุฑุจุฑ: ${userMessage}

ูุทูุงู ูพุงุณุฎ ฺฉุงููุ ููุฏ ู ุจู ูุงุฑุณ ุงุฑุงุฆู ุฏูุฏ:`;

      const result = await model.generateContent(prompt);
      const response = await result.response;
      const text = response.text();

      return text;
    } catch (error) {
      console.error('Error generating response from Gemini, falling back to static responses:', error);
      // Fall through to fallback system
    }
  }

  // Fallback to static responses
  const fallbackResponse = fallbackResponses[userMessage as keyof typeof fallbackResponses];
  
  if (fallbackResponse) {
    return fallbackResponse;
  }

  // Default fallback
  return 'ูุชุฃุณููุ ุงุทูุงุนุงุช ฺฉุงูู ุฏุฑ ุงู ุฒููู ูุฏุงุฑู. ูุทูุงู ุจุง ูุฒ ุฑุงูููุง ุฏุฑ ูุฑูุฏ ููุงุดฺฏุงู ุชูุงุณ ุจฺฏุฑุฏ ุง ุงุฒ ูพุฑุณุดโูุง ูพุดููุงุฏ ุงุณุชูุงุฏู ฺฉูุฏ.\n\n๐ ุชูุงุณ: ฐฒฑ-ธธททถถตต ุฏุงุฎู ฑฒณ';
}
